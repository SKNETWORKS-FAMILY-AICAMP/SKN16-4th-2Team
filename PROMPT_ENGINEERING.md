# 🎭 프롬프트 엔지니어링 구조

## 📋 개요

은행 신입사원 시뮬레이션 시스템의 프롬프트 아키텍처는 **페르소나 기반 대화 생성**에 최적화되어 있습니다.

---

## 🏗️ 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    프롬프트 파이프라인                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  1. STT (Speech-to-Text)                                    │
│     - whisper-1 (기본) → gpt-4o-transcribe (보정용)          │
│     - 의미 보정기로 품질 평가 및 재인식                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2. Banking Normalizer                                      │
│     - alias 교정 ("전기예금" → "정기예금")                    │
│     - fuzzy matching으로 오인식 수정                         │
│     - 상품 카탈로그 매칭                                      │
│     - 교정 횟수 기반 재확인 필요 여부 판단                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3. Prompt Orchestrator                                     │
│     - compose_llm_messages()                                │
│     - System + Developer + User 프롬프트 구성                │
│     - 페르소나, 상황, 히스토리, RAG 통합                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4. LLM (gpt-4o-mini)                                       │
│     - JSON 응답 생성                                         │
│     - script, followups, safety_notes, grounding            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  5. TTS (gpt-4o-mini-tts)                                   │
│     - get_voice_params() → voice/rate/pitch 계산             │
│     - build_ssml() → SSML 생성                               │
│     - 페르소나별 음성 특성 적용                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 핵심 파일

### 1. `promptOrchestrator.py` - 프롬프트 구성

#### `compose_llm_messages()` 함수
페르소나, 상황, 히스토리, RAG를 통합하여 LLM 메시지 생성

**입력 파라미터:**
- `persona`: 페르소나 정보 (gender, age_group, occupation, type, tone, style)
- `situation`: 상황 정보 (id, title, goals, required_slots, forbidden_claims)
- `user_text`: 정규화된 직원 발화
- `rag_hits`: RAG 검색 결과
- `history`: 대화 히스토리 (최근 4턴)
- `extras`: 추가 정보 (userText_raw, corrections, catalogHits, needs_clarification)

**프롬프트 구조:**

```python
messages = [
    {
        "role": "system",
        "content": """
🎭 당신은 실제 은행을 방문한 고객입니다...

[🏦 상황 설정]
- 당신: 은행 고객 (질문하고 요청하는 입장)
- 상대방: 은행 직원

[💬 자연스러운 대화 원칙]
1. 실제 사람처럼 말하기
2. 감정과 개성 표현
3. 대화 흐름 자연스럽게
4. 현실적인 고객 반응

[🎯 연령대별 말투]
- 20대: 친근하고 캐주얼
- 30-40대: 정중하지만 효율적
- 50대 이상: 더 정중하고 신중

[📋 출력 형식]
다음 JSON만 출력:
{
 "script": "<고객이 말할 한국어 문장들>",
 "followups": ["추가 질문"],
 "safety_notes": "",
 "grounding": ["참고한 doc_id"]
}
        """
    },
    {
        "role": "user",
        "content": """
[은행 직원 발화]
안녕하세요, 무엇을 도와드릴까요?

[선택된 페르소나]
여성, 20대, 학생, 고객타입=실용형...

[선택된 시츄에이션]
수신 상담, goals=...

[대화 맥락]
...
        """
    }
]
```

---

### 2. `persona_voice.py` - TTS 파라미터

#### `get_voice_params(persona)`
페르소나 속성에 따라 TTS 파라미터 계산

```python
def get_voice_params(persona: Dict) -> Dict:
    """페르소나 기반 TTS 파라미터"""
    # 성별 → voice
    base_voice = {"남성": "alloy", "여성": "verse"}.get(gender, "alloy")
    
    # 연령대 → rate (말속도)
    rate_map = {
        "20대": 1.15,  # 빠름
        "30대": 1.10,
        "40대": 1.00,  # 기본
        "50대": 0.95,
        "60대 이상": 0.90,  # 느림
    }
    
    # 고객 타입 → rate/pitch 조정
    type_adjust = {
        "실용형": {"rate": +0.05, "pitch": 0},
        "보수형": {"rate": -0.05, "pitch": -1},
        "불만형": {"rate": +0.05, "pitch": +1},
        "긍정형": {"rate": +0.10, "pitch": +1},
        "급함형": {"rate": +0.15, "pitch": +2},
    }
    
    return {
        "voice": base_voice,
        "rate": rate,
        "pitch": pitch
    }
```

#### `build_ssml(text, rate, pitch)`
SSML 생성 (OpenAI TTS용)

```xml
<speak>
  <prosody rate="1.15" pitch="+1">
    안녕하세요, 정기예금 상담 받고 싶어요.
  </prosody>
</speak>
```

---

## 🎭 페르소나별 대화 스타일

### 고객 타입별 반응 패턴

| 타입 | 특징 | 예시 |
|------|------|------|
| **실용형** | 직설적, 효율적 | "빨리 알려주세요", "간단히 말하면?" |
| **보수형** | 신중, 조심스러움 | "안전한가요?", "확실한 건가요?" |
| **불만형** | 약간 짜증스러움 | "왜 이렇게 복잡해요?" |
| **긍정형** | 밝고 협조적 | "좋네요!", "알겠어요!" |
| **급함형** | 서두르는 느낌 | "빨리요", "언제까지 되나요?" |

### 연령대별 말투

| 연령대 | 말투 |
|--------|------|
| **20대** | 친근, 캐주얼 ("그게 뭐예요?", "진짜요?") |
| **30-40대** | 정중, 효율적 ("그렇다면", "알겠습니다") |
| **50대 이상** | 더 정중, 신중 ("그런가요?", "혹시") |

---

## 🔄 대화 흐름 가이드

### 단계별 가이드

```python
"[대화 단계별 가이드]
- 첫 대화: 인사 + 목적 ('안녕하세요. 예금 상품 알아보러 왔어요')
- 2번째 이후: 직원 말에 직접 반응 ('그 상품들 이자율이 어떻게 되나요?')
- 진행 중: 더 구체적인 질문 ('기간은 얼마나 되나요?', '최소 금액이 있나요?')
- 마무리: 결정이나 추가 문의 ('좀 더 생각해볼게요', '신청하려면 어떻게 하나요?')
"
```

### 반복 방지

```
[🔥 중요]
- 이전 대화 내용을 절대 반복하지 마세요
- 이미 말한 인사나 목적을 다시 언급하지 마세요
- 첫 대화가 아니라면 '안녕하세요' 같은 말을 반복하지 않습니다
```

---

## 🔧 의미보정 통합

### 교정 정보 활용

```python
"[🔧 음성인식 교정 정보]
- '전기예금' → '정기예금' (alias)
- '자유 적금' → '자유적금' (fuzzy:90.5)
"

"[📋 매칭된 상품]
- 정기예금 (수신) - exact_match
- 자유적금 (수신) - partial_match
"

"[⚠️ 재확인 필요]
교정이 많거나 신뢰도가 낮아 재확인 질문을 포함하세요.
"
```

---

## 📊 LLM 응답 파싱

```python
def parse_llm_response(content: str) -> Dict:
    """LLM JSON 응답 파싱"""
    parsed = json.loads(content_clean)
    return {
        "script": parsed.get("script", ""),        # 고객이 말할 문장
        "followups": parsed.get("followups", []),  # 추가 질문
        "safety_notes": parsed.get("safety_notes", ""),  # 안전 메모
        "grounding": parsed.get("grounding", [])   # 참고 문서
    }
```

---

## 🎵 TTS 파이프라인

### 1. voice 파라미터 선택

```python
# 남성
"alloy", "echo", "fable"

# 여성  
"nova", "shimmer", "verse"
```

### 2. rate (말속도) 조정

```
기본: 1.0
연령대: ±0.05~0.15
고객 타입: ±0.05~0.15
```

### 3. pitch (음높이) 조정

```
기본: 0
감정 레벨: -2 ~ +2
고객 타입: -1 ~ +2
```

---

## 🔍 디버깅 및 모니터링

### 로그 출력 예시

```
🎤 1단계: whisper-1 기본 인식
초기 인식 결과: '안녕하세요 정기예금 상담받고 싶어요'

🔧 의미 보정 시작
원본: '안녕하세요 정기예금 상담받고 싶어요'
정규화: '안녕하세요 정기예금 상담받고 싶어요'
교정: [('예금', '정기예금', 'alias')]
재확인 필요: False

📋 상품 카탈로그 매칭 시작
카탈로그 매칭 결과: 2개
  - 정기예금 (수신)

🔍 RAG 검색 쿼리 확장
확장된 쿼리: ['안녕하세요 정기예금 상담받고 싶어요', '정기예금', '수신']

고객 응답 생성 시작
대화 히스토리: 1턴
  1. customer: 안녕하세요, 예금 상담 받고 싶어요

고객 응답 (script): '안녕하세요, 어떤 상품이 있나요?'

TTS 처리 시작
TTS 파라미터: {'voice': 'nova', 'rate': 1.15, 'pitch': 0}
TTS 성공: 1234 bytes
```

---

## 🚀 향후 개선 사항

- [ ] RAG 검색 결과 통합 (현재 빈 배열)
- [ ] 페르소나별 감정 표현 강화
- [ ] 대화 맥락 메모리 장기 저장
- [ ] 평가/피드백 시스템 강화
- [ ] A/B 테스트용 프롬프트 변형

---

## 📚 참고 자료

- OpenAI TTS Documentation: https://platform.openai.com/docs/guides/speech-to-text
- OpenAI Chat Completions: https://platform.openai.com/docs/guides/text-generation
- SSML Specification: https://www.w3.org/TR/speech-synthesis11/

